{% extends "layout.html" %}

{% block title %}
    Watchlist
{% endblock %}

{% block main %}
<div class="container">
    <h3 align="left">Your Watchlist</h3>
    <hr style="background-color: white;">
    <div class="row" id="watchlist-grid"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const grid = document.getElementById('watchlist-grid');
    try {
        const res = await fetch('/watchlist/data');
        const items = await res.json();
        if (!Array.isArray(items) || items.length === 0) {
            grid.innerHTML = '<p class="text-muted">Your watchlist is empty.</p>';
            return;
        }
        const frag = document.createDocumentFragment();
        items.forEach(item => {
            const col = document.createElement('div');
            col.className = 'col-md-2 col-sm-3 col-6 mb-4';
            col.innerHTML = `
                <div class="movie-card" onclick="todetails(event, '${item.id}', ${item.type})">
                    <img src="${item.poster || ''}" class="card-img" alt="${item.name}">
                    <div class="card-body">
                        <div class="card-title">${item.name}</div>
                        <div class="card-options">
                            <button class="btn more-btn" title="Remove" onclick="event.stopPropagation(); removeFromWatchlist('${item.id}', ${item.type})"></button>
                        </div>
                    </div>
                </div>`;
            frag.appendChild(col);
        });
        grid.appendChild(frag);
    } catch (e) {
        grid.innerHTML = '<p class="text-danger">Failed to load watchlist.</p>';
    }
});

async function removeFromWatchlist(id, type) {
    try {
        const response = await fetch('/watchlist?action=remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ media_id: id, media_type: type })
        });
        if (response.ok) {
            // Remove card from grid
            const grid = document.getElementById('watchlist-grid');
            const card = [...grid.querySelectorAll('.movie-card')].find(c => c.onclick?.toString().includes(`'${id}'`));
            if (card) card.parentElement.remove();
        }
    } catch {}
}
</script>
{% endblock %}

